/*
 * Copyright (C) 2009-2017 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/s2p/mm/lib/reuse/accounting/component/util/HelperFunctions"],function(C,H){"use strict";return C.extend("sap.ui.s2p.mm.lib.reuse.accounting.component.controller.AccountAssignmentDetail",{onInit:function(){this.oi18nModel=new sap.ui.model.resource.ResourceModel({bundleName:"sap.ui.s2p.mm.lib.reuse.accounting.messagebundle",bundleLocale:sap.ui.getCore().getConfiguration().getFormatLocale()});this.getView().setModel(this.oi18nModel,"i18n");this.oTextBundle=this.oi18nModel.getResourceBundle();this.oView=this.getView();this.binded=false;this.ownerData=null;this.oModel=null;this.sAccBindingPathEntityType=null;this.accAssignMetadata=[[],[]];this.oSmartForm=this.oView.byId("accAssignSmartForm");if(!this.oSmartForm){this.oSmartForm=sap.ui.getCore().byId("accAssignSmartForm");}this.bAccDetailsAsPopup=null;this.EditMode=null;},_setPopDisplay:function(m){this.bAccDetailsAsPopup=m;},_setEditMode:function(m){this.EditMode=m;},_setBackButtonVisibility:function(m){this.getView().byId("navBack").setVisible(m);},onBeforeRendering:function(){if(this.bAccDetailsAsPopup===false){this._setBackButtonVisibility(false);}if(!this.getOwnerComponent()){this.ownerData=this.ownerData;}else{this.ownerData=this.getOwnerComponent().oComponentData;}this.oModel=this.ownerData.oModel;if(!this.oModel){this.oModel=this.getView().getModel();}if(!this.sAccBindingPathEntityType){this.sAccBindingPathEntityType="/"+this.getOwnerComponent().oComponentData.sAccBindingPathEntityType;}this.oSmartForm.setEntityType(this.ownerData.sAccEntityTypeName);H.setLayoutProperties(this.oView);if(this.accAssignMetadata[0].length===0&&this.accAssignMetadata[1].length===0){this.accAssignMetadata=this.addAccAssignAttributesFromMetaData(this.oModel,this.oView,this.ownerData.sAccEntityTypeName);}this.getView().setModel(this.oModel);this.oSmartForm.setModel(this.oModel);this.oSmartForm.bindElement(this.sAccBindingPathEntityType);this.getView().byId("accAssignSmartForm").setEditable(this.EditMode);},setContextPath:function(b){this.sAccBindingPathEntityType=b;},NavBack:function(e){this.getOwnerComponent().fireEvent("listNavigation",{accountingEvent:e});},setOwnerData:function(o){this.ownerData=o;},addAccAssignAttributesFromMetaData:function(m,v,e){var a=H.getAttributesFromMetadata(m,e);var A=H.getAccAssignAnnotationFromMetadata(m,e,"AccGroup");var o=H.getAccAssignAnnotationFromMetadata(m,e,"SecondGroup");var b=H.getAccAssignAnnotationFromMetadata(m,e,"ThirdGroup");var g=sap.ui.getCore().byId("AccGroup");if(!g){g=v.byId("AccGroup");}H.clearAttributes(g);var G=sap.ui.getCore().byId("SecondGroup");if(!G){G=v.byId("SecondGroup");}H.clearAttributes(G);var c=sap.ui.getCore().byId("ThirdGroup");if(!c){c=v.byId("ThirdGroup");}H.clearAttributes(c);var d=[];var i,j,k;var f,p,t;if(A){if(A.length===0){g.setVisible(false);}for(i=0;i<A.length;i++){t=false;if(A[i].propertyValue){if(A[i].propertyValue[0].path.lastIndexOf("_Text")===-1){p=A[i].propertyValue[0].path;for(f=0;f<A.length;f++){if(A[f].propertyValue[0].path===p+"_Text"){t=true;break;}}if(t===true){this.addAccAssignAttribute(v,g,A[i].propertyValue[0].path,"accAssignGroupElement",t);}else{this.addAccAssignAttribute(v,g,A[i].propertyValue[0].path,"accAssignGroupElement");}d.push(g,A[i].propertyValue[0].path);}}else{for(k=0;k<A[i].length;k++){if(A[i][k].Value.Path.lastIndexOf("_Text")!==A[i][k].Value.Path.length-"_Text".length){this.addAccAssignAttribute(v,g,A[i][k].Value.Path,"accAssignGroupElement");d.push(g,A[i][k].Value.Path);}}}}}else{if(g){g.destroy();}}if(o){if(o.length===0){G.setVisible(false);}for(i=0;i<o.length;i++){if(o[i].propertyValue){this.addAccAssignAttribute(v,G,o[i].propertyValue[0].path,"accAssignGroupElement");d.push(G,o[i].propertyValue[0].path);}else{for(k=0;k<o[i].length;k++){if(o[i][k].Value.Path.lastIndexOf("_Text")!==o[i][k].Value.Path.length-"_Text".length){this.addAccAssignAttribute(v,G,o[i][k].Value.Path,"accAssignGroupElement");d.push(G,o[i][k].Value.Path);}}}}}else{if(G){G.destroy();}}if(b){if(b.length===0){c.setVisible(false);}for(i=0;i<b.length;i++){if(b[i].propertyValue){this.addAccAssignAttribute(v,c,b[i].propertyValue[0].path,"accAssignGroupElement");d.push(c,b[i].propertyValue[0].path);}else{for(k=0;k<b[i].length;k++){if(b[i][k].Value.Path.lastIndexOf("_Text")!==b[i][k].Value.Path.length-"_Text".length){this.addAccAssignAttribute(v,c,b[i][k].Value.Path,"accAssignGroupElement");d.push(c,b[i][k].Value.Path);}}}}}else{if(c){c.destroy();}}return[d];},addAccAssignAttribute:function(v,g,a,G,t){var V=v.getId();var o=new sap.ui.comp.smartform.GroupElement();var s=new sap.ui.comp.smartfield.SmartField({id:V+"_"+G+a,value:"{"+a+"}"});s.attachEvent("change",this.changeAccounting,this);var c=new sap.ui.comp.smartfield.Configuration();c.setDisplayBehaviour("descriptionAndId");s.setConfiguration(c);o.addElement(s);if(this.EditMode===true&&t===true){var S=new sap.ui.comp.smartfield.SmartField({id:V+"_"+G+a+"_Text",value:"{"+a+"_Text}",showLabel:false,editable:false});o.addElement(S);}g.addGroupElement(o);},changeAccounting:function(){this.getView().setBusy(true);var O=this.getView().byId("accAssignSmartForm").getBindingContext().getModel().getData(this.getView().byId("accAssignSmartForm").getBindingContext().getPath());var p;try{delete O.HasDraftEntity;delete O.DraftAdministrativeDataUUID;delete O.IsActiveEntity;delete O.HasActiveEntity;delete O.MultipleAcctAssgmtDistrPercent;delete O.CompanyCode;delete O.CostElement;delete O.PurReqnAcctDraftUUID;delete O.PurReqnDraftUUID;delete O.PurReqnItemDraftUUID;for(p in O)if(typeof(O[p])==="object"){delete O[p];}for(p in O){if(p.search('UxFc')!==-1){delete O[p];}}}catch(e){}this.adjustPayload(O);var m=this.getView().byId("accAssignSmartForm").getBindingContext().getModel();if(m){m.update(this.getView().byId("accAssignSmartForm").getBindingContext().getPath(),O,{"success":jQuery.proxy(this.successHandler,this),"error":jQuery.proxy(this.errorHandler,this)});}else{this.getView().getModel().update(this.getView().byId("accAssignSmartForm").getBindingContext().getPath(),O,{"success":jQuery.proxy(this.successHandler,this),"error":jQuery.proxy(this.errorHandler,this)});}},successHandler:function(){sap.m.MessageToast.show(this.oTextBundle.getText("updateSuccess"));this.getView().byId("accAssignSmartForm").getBindingContext().getModel().refresh();this.getView().setBusy(false);},errorHandler:function(){},adjustPayload:function(d){for(var p in d){if(p.search('_fc')<0){var a=p.toString()+"_fc";if(d[a]===1||d[a]===0){delete d[p];delete d[a];}}}return d;}});});
