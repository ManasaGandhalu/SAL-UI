/*
 * Copyright (C) 2009-2017 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/Dialog","sap/ui/s2p/mm/lib/reuse/accounting/component/util/HelperFunctions"],function(C,D){"use strict";return C.extend("sap.ui.s2p.mm.lib.reuse.accounting.component.controller.AccountAssignment",{onInit:function(){this.oi18nModel=new sap.ui.model.resource.ResourceModel({bundleName:"sap.ui.s2p.mm.lib.reuse.accounting.messagebundle",bundleLocale:sap.ui.getCore().getConfiguration().getFormatLocale()});this.getView().setModel(this.oi18nModel,"i18n");this.oTextBundle=this.oi18nModel.getResourceBundle();this.accAssignMetadata=[[],[]];this.bAccDetailsAsPopup=null;this.EditMode=null;this.ShowHeader=null;this.oDialog=null;this.sAccEntitySetName=this.getOwnerComponent().oComponentData.sAccEntitySetName;this.sAccTableBindingPath=this.getOwnerComponent().oComponentData.sAccBindingPathEntitySet;this.oModel="";if(this.getOwnerComponent().oComponentData.oModel){this.oModel=this.getOwnerComponent().oComponentData.oModel;}else{this.oModel=this.getView().getModel();}},_setDetailsButtonVisibility:function(v){this.getView().byId("detailsButton").setVisible(v);},_showNavigationButton:function(){this.getView().byId("accountColumn").setType("Navigation");},_showListCRUDActions:function(){this.getView().byId("addButton").setEnabled(this.EditMode);this.getView().byId("deleteButton").setEnabled(this.EditMode);},_showListHeader:function(){if(this.ShowHeader){this.getView().byId("accBasicTable").setHeader(this.oTextBundle.getText("header"));this.getView().byId("accBasicTable").setShowRowCount(true);}},onUpdateFinished:function(){this.getView().byId("accountingTable").getItems()[0].setSelected(true);},onBeforeRendering:function(){if(this.bAccDetailsAsPopup===true){this._setDetailsButtonVisibility(true);}if(this.bAccDetailsAsPopup===false){this._showNavigationButton();this._setDetailsButtonVisibility(false);}this._showListCRUDActions();this._showListHeader();this.getView().byId("accBasicTable").setEditable(this.EditMode);},_setPopDisplay:function(m){this.bAccDetailsAsPopup=m;},_setEditMode:function(m){this.EditMode=m;},_setShowHeader:function(m){this.ShowHeader=m;},onAfterRendering:function(){this.getView().setModel(this.oModel);this.getView().byId("accBasicTable").setModel(this.oModel);this.getView().byId("accBasicTable").setEntitySet(this.sAccEntitySetName);this.getView().byId("accBasicTable").setTableBindingPath(this.sAccTableBindingPath);this.getView().byId("accBasicTable").setEditable(this.EditMode);},onDetail:function(){var l=this.getView().byId("accountingTable").getSelectedContexts();if(l.length>0){this.bindingPath=this.getView().byId("accountingTable").getSelectedContexts()[0].getPath();this.page=new sap.ui.view({viewName:"sap.ui.s2p.mm.lib.reuse.accounting.component.view.AccountAssignmentDetail",type:sap.ui.core.mvc.ViewType.XML});var t=this;this.oDialog=new D({title:this.oTextBundle.getText("accAssignTitle"),content:this.page,beginButton:new sap.m.Button({text:"Close",press:function(){t.oDialog.close();}})});this.getView().addDependent(this.oDialog);this.page.getController().setContextPath(this.bindingPath);this.page.getController()._setEditMode(this.EditMode);this.page.getController().setOwnerData(this.getOwnerComponent().oComponentData);this.oModel.read(this.bindingPath,{success:jQuery.proxy(this.onRead,this)});}else{sap.m.MessageToast.show(this.oTextBundle.getText("accErrorMessage"));}},onRead:function(){this.oDialog.open();},onLineItemPressed:function(e){var l=this.getView().byId("accountingTable").getSelectedContexts();if(l.length>0){var p=this.getView().byId("accountingTable").getSelectedContexts()[0].getPath();this.getOwnerComponent().fireEvent("detailNavigation",{detailEvent:e,bindpath:p});}else{sap.m.MessageToast.show(this.oTextBundle.getText("accErrorMessage"));}},onCloseDialog:function(){this._oDialog.close();},onCreate:function(e){var E=e;var u=this.sAccTableBindingPath;var d={Quantity:"0.000"};this.oModel.create(u,d,{success:jQuery.proxy(this.successHandlerCreate,this,E),error:jQuery.proxy(this.errorHandlerCreate,this)});},successHandlerCreate:function(e,r){var l=r.__metadata.uri;var a=l.split("/");this.bindingPath="/"+a[a.length-1];if(this.bAccDetailsAsPopup===true){this.onDetailAfterCreate(this.bindingPath);}if(this.bAccDetailsAsPopup===false){this.onLineItemPressedAfterCreate(e,this.bindingPath);}this.getView().byId("accountingTable").getModel().refresh();},onDetailAfterCreate:function(b){this.bindingPath=b;this.page=new sap.ui.view({viewName:"sap.ui.s2p.mm.lib.reuse.accounting.component.view.AccountAssignmentDetail",type:sap.ui.core.mvc.ViewType.XML});var d=new D({content:this.page,beginButton:new sap.m.Button({text:"Close",press:function(){d.close();}})});this.getView().addDependent(d);this.page.getController().setContextPath(this.bindingPath);this.page.getController()._setEditMode(this.EditMode);this.page.getController().setOwnerData(this.getOwnerComponent().oComponentData);d.open();},onLineItemPressedAfterCreate:function(e,b){var p=b;this.getOwnerComponent().fireEvent("detailNavigation",{detailEvent:e,bindpath:p});},onDelete:function(){var b=this.getView().byId("accountingTable").getSelectedContexts()[0].getPath();this.oModel.remove(b,{batchGroupId:1,changeSetId:1,success:jQuery.proxy(this.successHandlerDelete,this)});},successHandlerDelete:function(){var s=this.oTextBundle.getText("msg_success_delete");sap.m.MessageToast.show(s,{duration:2000});this.oModel.refresh();},updateAccList:function(s,a,p){var m=this.oModel;var b=[];var o=[];for(var c in m.oData){if(c.indexOf(this.sAccEntitySetName)>=0){b.push(c);}}for(var i=0;i<b.length;i++){var d=m.getData("/"+b[i]);var f;try{if(d.hasOwnProperty('HasDraftEntity')){delete d.HasDraftEntity;}delete d.DraftAdministrativeDataUUID;delete d.IsActiveEntity;delete d.HasActiveEntity;delete d.MultipleAcctAssgmtDistrPercent;delete d.CompanyCode;delete d.CostElement;delete d.PurReqnAcctDraftUUID;delete d.PurReqnDraftUUID;delete d.PurReqnItemDraftUUID;for(f in d)if(typeof(d[f])==="object"){delete d[f];}for(f in d){if(f.search('UxFc')!==-1){delete d[f];}}o.push(this.adjustPayload(d));}catch(e){}}var l=b.length;var g=0;this.accountObject={length1:l,count:g,accEntityList:b,oData:o,errorFunction:a};m.update("/"+b[g],o[g],{success:jQuery.proxy(this.successHandler,this,s,p),error:jQuery.proxy(this.errorHandler,this,a,p)});},successHandler:function(s,d){this.accountObject.count=this.accountObject.count+1;if(this.accountObject.count>=this.accountObject.length1){s(d);}else{this.oModel.update("/"+this.accountObject.accEntityList[this.accountObject.count],this.accountObject.oData[this.accountObject.count],{success:jQuery.proxy(this.successHandler,this,s,d),error:jQuery.proxy(this.errorHandler,this,this.accountObject.errorFunction,d)});}},errorHandler:function(e,d){e(d);},adjustPayload:function(d){for(var p in d){if(p.search('_fc')<0){var a=p.toString()+"_fc";if(d[a]===1||d[a]===0){delete d[p];delete d[a];}}}return d;}});});
